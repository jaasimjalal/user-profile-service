import { Router, Request, Response } from 'express';\nimport { v4 as uuidv4 } from 'uuid';\nimport { \n  validateRequest, \n  createUserSchema, \n  updateUserSchema, \n  idParamsSchema,\n  paginationSchema \n} from '../middleware/validationMiddleware';\nimport { NotFoundError, ConflictError, HttpError } from '../middleware/errorHandler';\nimport { db } from '../database';\nimport { logger } from '../utils/logger';\n\nconst router = Router();\n\ninterface User {\n  id: string;\n  name: string;\n  email: string;\n  age?: number;\n  createdAt: string;\n  updatedAt: string;\n}\n\ninterface CreateUserRequest {\n  name: string;\n  email: string;\n  age?: number;\n}\n\ninterface UpdateUserRequest {\n  name?: string;\n  email?: string;\n  age?: number;\n}\n\ninterface PaginationQuery {\n  page?: number;\n  limit?: number;\n}\n\n// GET /api/users - Get all users (paginated)\nrouter.get('/', \n  validateRequest(paginationSchema, 'query'),\n  async (req: Request<{}, {}, {}, PaginationQuery>, res: Response) => {\n    try {\n      const page = parseInt(req.query.page as string) || 1;\n      const limit = parseInt(req.query.limit as string) || 10;\n      const offset = (page - 1) * limit;\n\n      // Get total count\n      const countResult = await db.query('SELECT COUNT(*) FROM users');\n      const total = parseInt(countResult.rows[0].count);\n\n      // Get users with pagination\n      const result = await db.query<User>('SELECT * FROM users ORDER BY createdAt DESC LIMIT $1 OFFSET $2', [limit, offset]);\n      \n      const totalPages = Math.ceil(total / limit);\n\n      res.status(200).json({\n        data: result.rows,\n        pagination: {\n          page,\n          limit,\n          total,\n          totalPages\n        }\n      });\n    } catch (error) {\n      logger.error('Error fetching users', { error: String(error) });\n      throw new HttpError('Failed to fetch users', 500, 'DATABASE_ERROR');\n    }\n  }\n);\n\n// GET /api/users/:id - Get user by ID\nrouter.get('/:id', \n  validateRequest(idParamsSchema, 'params'),\n  async (req: Request<{ id: string }>, res: Response) => {\n    try {\n      const result = await db.query<User>('SELECT * FROM users WHERE id = $1', [req.params.id]);\n      \n      if (result.rows.length === 0) {\n        throw new NotFoundError('User not found');\n      }\n\n      res.status(200).json(result.rows[0]);\n    } catch (error) {\n      if (error instanceof NotFoundError) {\n        throw error;\n      }\n      logger.error('Error fetching user', { error: String(error), id: req.params.id });\n      throw new HttpError('Failed to fetch user', 500, 'DATABASE_ERROR');\n    }\n  }\n);\n\n// POST /api/users - Create new user\nrouter.post('/', \n  validateRequest(createUserSchema, 'body'),\n  async (req: Request<{}, {}, CreateUserRequest>, res: Response) => {\n    try {\n      const { name, email, age } = req.body;\n      const id = uuidv4();\n      const now = new Date().toISOString();\n\n      // Check if email already exists\n      const existingUser = await db.query('SELECT id FROM users WHERE email = $1', [email]);\n      if (existingUser.rows.length > 0) {\n        throw new ConflictError('Email already exists');\n      }\n\n      // Insert new user\n      const result = await db.query<User>(\n        'INSERT INTO users (id, name, email, age, \"createdAt\", \"updatedAt\") VALUES ($1, $2, $3, $4, $5, $6) RETURNING *',\n        [id, name, email, age || null, now, now]\n      );\n\n      res.status(201).json(result.rows[0]);\n    } catch (error) {\n      if (error instanceof ConflictError) {\n        throw error;\n      }\n      logger.error('Error creating user', { error: String(error), body: req.body });\n      throw new HttpError('Failed to create user', 500, 'DATABASE_ERROR');\n    }\n  }\n);\n\n// PUT /api/users/:id - Update user\nrouter.put('/:id', \n  validateRequest(idParamsSchema, 'params'),\n  validateRequest(updateUserSchema, 'body'),\n  async (req: Request<{ id: string }, {}, UpdateUserRequest>, res: Response) => {\n    try {\n      const { name, email, age } = req.body;\n      const now = new Date().toISOString();\n\n      // Check if user exists\n      const existingUser = await db.query('SELECT id FROM users WHERE id = $1', [req.params.id]);\n      if (existingUser.rows.length === 0) {\n        throw new NotFoundError('User not found');\n      }\n\n      // Check if email already exists (if updating email)\n      if (email) {\n        const emailCheck = await db.query(\n          'SELECT id FROM users WHERE email = $1 AND id != $2',\n          [email, req.params.id]\n        );\n        if (emailCheck.rows.length > 0) {\n          throw new ConflictError('Email already exists');\n        }\n      }\n\n      // Build dynamic update query\n      const updates: string[] = [];\n      const values: any[] = [req.params.id];\n      let paramCount = 2;\n\n      if (name !== undefined) {\n        updates.push(`name = $${paramCount}`);\n        values.push(name);\n        paramCount++;\n      }\n      if (email !== undefined) {\n        updates.push(`email = $${paramCount}`);\n        values.push(email);\n        paramCount++;\n      }\n      if (age !== undefined) {\n        updates.push(`age = $${paramCount}`);\n        values.push(age);\n        paramCount++;\n      }\n\n      if (updates.length === 0) {\n        throw new HttpError('No fields to update', 400, 'NO_UPDATES');\n      }\n\n      updates.push(`\"updatedAt\" = $${paramCount}`);\n      values.push(now);\n\n      const query = `UPDATE users SET ${updates.join(', ')} WHERE id = $1 RETURNING *`;\n      const result = await db.query<User>(query, values);\n\n      if (result.rows.length === 0) {\n        throw new NotFoundError('User not found');\n      }\n\n      res.status(200).json(result.rows[0]);\n    } catch (error) {\n      if (error instanceof NotFoundError || error instanceof ConflictError || error instanceof HttpError) {\n        throw error;\n      }\n      logger.error('Error updating user', { error: String(error), id: req.params.id, body: req.body });\n      throw new HttpError('Failed to update user', 500, 'DATABASE_ERROR');\n    }\n  }\n);\n\n// DELETE /api/users/:id - Delete user\nrouter.delete('/:id', \n  validateRequest(idParamsSchema, 'params'),\n  async (req: Request<{ id: string }>, res: Response) => {\n    try {\n      const result = await db.query('DELETE FROM users WHERE id = $1 RETURNING id', [req.params.id]);\n      \n      if (result.rows.length === 0) {\n        throw new NotFoundError('User not found');\n      }\n\n      res.status(200).json({ message: 'User deleted successfully', id: req.params.id });\n    } catch (error) {\n      if (error instanceof NotFoundError) {\n        throw error;\n      }\n      logger.error('Error deleting user', { error: String(error), id: req.params.id });\n      throw new HttpError('Failed to delete user', 500, 'DATABASE_ERROR');\n    }\n  }\n);\n\nexport default router;"}